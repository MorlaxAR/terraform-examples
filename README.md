<a name="readme-top"></a>
<br />
<div align="center">
  <a href="https://github.com/MorlaxAR/terraform-examples">
    <img src="https://img.shields.io/badge/terraform-%235835CC.svg?style=for-the-badge&logo=terraform&logoColor=white" alt="Logo" width="" height="40">
  </a>
<br />
<h2 align="center">terraform-examples</h3>

  <p align="center">
    Centralized repository showing examples of Terraform and Terragrunt in multiple providers
    <br />
  </p>
</div>

<details>
  <summary>Table of Contents</summary>
  <ol>
    <li>
      <a href="#about-the-project">About The Project</a>
      <ul>
        <li><a href="#technologies-used">Technologies Used</a></li>
      </ul>
    </li>
    <li>
      <a href="#project-structure">Project Structure</a>
    </li>
    <li>
      <a href="#getting-started">Getting Started</a>
      <ul>
        <li><a href="#prerequisites">Prerequisites</a></li>
      </ul>
    </li>
  </ol>
</details>

## About The Project
The objective of this repository is to have our infrastructure defined as code as much as possible. 

Why this is important:
 - We reduce human error when creating resources.
 - We can use this repository as  our documentation and history of the infrastructure.
 - We ensure that our infrastructure is easy to replicate, specially useful when deploying the same resources in different environments or projects.
 - In case of a disaster (sudden loss of a GCP account, for example), we can recover much faster.
 - The same processes that are used to approve changes to code can be used for infrastructure.

 We use a monorepo to allow for easier sharing of common modules. The directory structure is set up in such a way that we can manage different providers with ease, even if the structure ends up being quite vertical.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Technologies Used
This project is built using Terraform and Terragrunt.

Terragrunt is a thin wrapper for Terraform that provides tools to keep our configurations DRY.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

## Project Structure
For this project, we use a custom structure to manage the different resources and envionments instead of what is recommended in the Terraform docs. We rely on different directories to separate different environments instead of using Terraform Workspaces. This was chosen to maximize flexibility, allowing environments to differ as needed.

Example GCP project structure:

```
terragrunt.hcl
global.hcl
gcp
│  
└───projects
│   │
│   └───project_A
│   |   │   backend.hcl
│   |   │   project.hcl
│   |   │
|   |   └───resource_A
|   |          terragrunt.hcl
|   |          backend.tf
|   |          variables.tf
|   |          ...
|   |
|   └───project_B
|   |   ...
|   |
|   ... 
|
└───organization
    │   backend.hcl
    │
    └───resource_A
    |      terragrunt.hcl
    ...    backend.tf
           variables.tf
           ...
```

Each deployable directory will have a `terragrunt.hcl` file, that *MUST* include every parent terragrunt file, even if it doesn't use the inputs they define.

For example, a GCP resource for a specific Project will include:
-  The `terragrunt.hcl` file in the root of the repository.
- The `global.hcl` file in the root of the repository.
- The `project.hcl` file in the project's directory

The file would look like this:

```hcl
include "root" {
  path = find_in_parent_folders("terragrunt.hcl")
}

inputs = merge(
  read_terragrunt_config(find_in_parent_folders("global.hcl")).inputs,
  read_terragrunt_config(find_in_parent_folders("project.hcl")).inputs,
  {
    resource_variable_1 = "variable_value_1"
    resource_variable_2 = "variable_value_2"
    ...
  }
)
```
Every deployable directory *MUST* also have a basic `backend.tf` file specifying the backend:

```terraform
terraform {
  backend "local" {}
}
```
The configuration is dynamically generated by the root `terragrunt.hcl`, removing the need of manually configuring the path of the state file and avoid overlaps.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

## Getting Started

Simple instructions to set up the project locally.

### Prerequisites

1. Have Terraform installed (https://learn.hashicorp.com/tutorials/terraform/install-cli)
2. Have Terragrunt installed (https://terragrunt.gruntwork.io/docs/getting-started/install/)
3. For Google Resources: Have a valid gcloud CLI and login with permissions
4. For GitHub: Configure the GITHUB_TOKEN environment variable


<p align="right">(<a href="#readme-top">back to top</a>)</p>

<p align="right">(<a href="#readme-top">back to top</a>)</p>